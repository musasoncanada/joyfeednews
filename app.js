const API='/.netlify/functions/happy-news';const g=document.getElementById('grid'),c=document.getElementById('chips'),sI=document.getElementById('search'),cS=document.getElementById('categorySel'),rS=document.getElementById('regionSel'),rB=document.getElementById('refreshBtn'),iS=document.getElementById('intervalSel'),lB=document.getElementById('loadMoreBtn'),st=document.getElementById('statusLine'),tB=document.getElementById('themeBtn');let all=[],shown=0;const page=24;let timer=null;const CHIPS=['Community','Wildlife','Science','Climate','Humanity','Arts','Scholarship','Rescue','Solar','Teacher'];function ago(x){const n=new Date(),d=new Date(x);const s=Math.max(1,Math.floor((n-d)/1e3));const u=[['year',31536e3],['month',2592e3],['week',604800],['day',86400],['hour',3600],['minute',60]];for(const[k,v]of u){const val=Math.floor(s/v);if(val>=1)return `${val} ${k}${val>1?'s':''} ago`}return'just now'}function schema(items){return{'@context':'https://schema.org','@type':'ItemList',name:'JoyFeed News stories',itemListElement:items.slice(0,20).map((it,i)=>({'@type':'ListItem',position:i+1,url:it.link,name:it.title}))}}function card(it){const cats=it.categories||[];const rb=it.region?`<span class="badge Region">${it.region}</span>`:'';const bs=cats.map(x=>`<span class="badge ${x}">${x}</span>`).join('')+rb;const img=it.image?`<img class="thumb" alt="" loading="lazy" src="${it.image}">`:'';const first=cats[0]||'';return `<article class="card" data-cat="${first}">${img}<a href="${it.link}" target="_blank" rel="noopener"><h3>${it.title}</h3><p class="muted">${it.excerpt||''}</p><div class="meta"><span>${it.site||it.sourceTitle||'Source'}</span><span>•</span><time datetime="${it.isoDate}">${ago(it.isoDate)}</time></div><div class="badges">${bs}</div></a></article>`}function render(reset=false){if(!g)return;if(reset){shown=0;g.innerHTML=''}const slice=all.slice(shown,shown+page);if(!slice.length&&shown===0){g.innerHTML=`<div class="card" style="padding:20px"><h3>No stories yet</h3><p class="muted">Try Refresh — we’ll keep pulling new happy news ✨</p></div>`}else{g.insertAdjacentHTML('beforeend',slice.map(card).join(''))}shown+=slice.length;lB.style.display=shown<all.length?'inline-block':'none';const el=document.getElementById('schema-json');if(el)el.textContent=JSON.stringify(schema(all),null,2)}async function load(){try{rB.disabled=true;rB.textContent='Loading…';st.textContent='Fetching uplifting stories…';const p=new URLSearchParams(location.search);const q=(sI?.value||'').trim(),cat=cS?.value||'',reg=rS?.value||'';if(q)p.set('q',q);if(cat)p.set('category',cat);if(reg)p.set('region',reg);p.set('fast','1');const res=await fetch(`${API}?${p.toString()}`,{cache:'no-store'});const data=await res.json();all=data.items||[];render(true);st.textContent=`Updated ${data.updatedAt?ago(data.updatedAt):'just now'} • ${all.length} stories`}catch(e){console.error(e);st.textContent='Could not load stories.';g.innerHTML=`<p class="muted">Something went wrong. Try Refresh.</p>`}finally{rB.disabled=false;rB.textContent='Refresh'}}function writeURL(){const p=new URLSearchParams(location.search);const cat=cS?.value||'',reg=rS?.value||'';cat?p.set('category',cat):p.delete('category');reg?p.set('region',reg):p.delete('region');history.pushState({category:cat,region:reg},'',`?${p.toString()}`)}function readURL(){const p=new URLSearchParams(location.search);const cat=p.get('category')||'',reg=p.get('region')||'';if(cS)cS.value=cat;if(rS)rS.value=reg}function apply(){writeURL();render(true);load()}rB?.addEventListener('click',load);sI?.addEventListener('change',apply);cS?.addEventListener('change',apply);rS?.addEventListener('change',apply);lB?.addEventListener('click',()=>render(false));if(c){c.innerHTML=CHIPS.map(t=>`<button class="ghost" data-chip="${t}">${t}</button>`).join('');c.addEventListener('click',e=>{const b=e.target.closest('[data-chip]');if(!b)return;cS.value=b.dataset.chip;apply()})}g?.addEventListener('click',e=>{const b=e.target.closest('.badge');if(!b)return;const t=b.textContent.trim();if(!t||t==='Region')return;cS.value=t;apply()});window.addEventListener('popstate',()=>{readURL();render(true);load()});tB?.addEventListener('click',()=>{const n=document.documentElement.dataset.theme==='dark'?'light':'dark';document.documentElement.dataset.theme=n;localStorage.setItem('theme',n)});document.documentElement.dataset.theme=localStorage.getItem('theme')||'';iS?.addEventListener('change',()=>{if(timer){clearInterval(timer);timer=null}const m=parseInt(iS.value,10);if(m>0)timer=setInterval(load,m*60*1000)});if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{})}readURL();load();